<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Set Your Password ‚Ä¢ One Hope</title>
  <link rel="stylesheet" href="/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Splash/Loading Screen -->
  <div id="splash" class="screen active" style="display:flex;align-items:center;justify-content:center;text-align:center;background:#00A0DF;color:#fff;">
    <div>
      <div class="logo" style="margin-bottom:16px;">
        <img src="/images/01_OneHopePrimary_Light.png" alt="One Hope" style="max-width: 160px; height: auto;" />
      </div>
      <p class="tagline" style="opacity:.9">Preparing password setup‚Ä¶</p>
      <div class="loading-dots"><span></span><span></span><span></span></div>
    </div>
  </div>

  <div id="setPassword" class="screen" style="transform:none;">
    <div class="auth-container">
      <div class="auth-header">
        <h1>Set Your Password</h1>
        <p>Create a secure password for your One Hope account</p>
      </div>
      <div class="auth-form">
        <form id="set-password-form" onsubmit="return false;">
          <div class="input-group input-with-icon">
            <label for="password">Password</label>
            <div class="input-wrapper">
              <i class="fas fa-lock input-icon-left" aria-hidden="true"></i>
              <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" required minlength="8" />
              <button type="button" class="input-suffix" aria-label="Show password" onclick="togglePw('password')"><i class="fas fa-eye"></i></button>
            </div>
            <small class="helper-text" style="color: #718096; font-size: 13px; margin-top: 4px;">
              Must be at least 8 characters
            </small>
          </div>
          <div class="input-group input-with-icon">
            <label for="confirmPassword">Confirm Password</label>
            <div class="input-wrapper">
              <i class="fas fa-lock input-icon-left" aria-hidden="true"></i>
              <input id="confirmPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" required minlength="8" />
              <button type="button" class="input-suffix" aria-label="Show password" onclick="togglePw('confirmPassword')"><i class="fas fa-eye"></i></button>
            </div>
          </div>
          <div id="msg" class="helper-text" role="status" aria-live="polite"></div>
          <div class="form-actions">
            <button id="btn-set-password" class="btn-primary" type="button">
              <i class="fas fa-key"></i> Set Password
            </button>
          </div>
        </form>
      </div>
      <div class="auth-links">
        <p>Need help? <a href="mailto:info@onehopechurch.com">Contact us</a></p>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    let sb = null;
    let supabaseUser = null;
    let currentAuthFlow = null; // 'invite', 'recovery', or 'signup'

    function getRememberPreference() {
      if (typeof window === 'undefined') return true;
      try {
        const stored = localStorage.getItem('remember_me_preference');
        if (stored === 'false') return false;
        if (stored === 'true') return true;
      } catch (error) {
        console.warn('‚ö†Ô∏è Unable to read remember preference:', error);
      }
      return true;
    }

    function persistRememberPreference(value) {
      if (typeof window === 'undefined') return;
      try {
        localStorage.setItem('remember_me_preference', value ? 'true' : 'false');
      } catch (error) {
        console.warn('‚ö†Ô∏è Unable to save remember preference:', error);
      }
    }

    // Get return URL from query parameter
    function getReturnUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('return') || '/';
    }

    // Initialize Supabase client
    async function init() {
      try {
        const r = await fetch('/api/config');
        if (!r.ok) {
          console.error('‚ùå Failed to fetch config:', r.status, r.statusText);
          setMsg('Failed to load configuration. Please refresh the page.', 'error');
          return;
        }
        const cfg = await r.json();
        console.log('üîß Config loaded:', { 
          hasUrl: !!cfg.supabaseUrl, 
          hasKey: !!cfg.supabaseAnonKey,
          urlLength: cfg.supabaseUrl?.length || 0,
          keyLength: cfg.supabaseAnonKey?.length || 0
        });
        
        if (!cfg.supabaseUrl || !cfg.supabaseAnonKey) {
          console.error('‚ùå Missing Supabase config:', cfg);
          setMsg('Missing Supabase configuration. Please check server settings.', 'error');
          return;
        }
        
        sb = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
        console.log('‚úÖ Supabase client initialized');

        // Check for auth tokens in URL (from Supabase redirect)
        // Don't wait for this - let it run in background
        handleAuthRedirect();

        // Hide splash and show form
        const splash = document.getElementById('splash');
        const setPassword = document.getElementById('setPassword');
        if (splash) splash.classList.remove('active');
        if (setPassword) setPassword.classList.add('active');
      } catch (e) {
        console.error('‚ùå Init error:', e);
        setMsg('Failed to initialize: ' + (e.message || 'Unknown error'), 'error');
      }
    }

    // Handle Supabase auth redirect (tokens in URL hash or params)
    async function handleAuthRedirect() {
      try {
        // First check for error parameters in URL (from Supabase redirect)
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        const errorCode = urlParams.get('error_code');
        const errorDescription = urlParams.get('error_description');
        
        // Check hash for errors too
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const hashError = hashParams.get('error');
        const hashErrorCode = hashParams.get('error_code');
        const hashErrorDescription = hashParams.get('error_description');
        
        const finalError = error || hashError;
        const finalErrorCode = errorCode || hashErrorCode;
        const finalErrorDescription = errorDescription || hashErrorDescription;
        const errorFlowType = urlParams.get('type') || hashParams.get('type');
        const hintedFlowMode = urlParams.get('mode');

        if (!currentAuthFlow && (errorFlowType || hintedFlowMode)) {
          currentAuthFlow = errorFlowType || hintedFlowMode;
        }

        if (finalError) {
          console.error('‚ùå Supabase redirect error:', finalError, finalErrorCode, finalErrorDescription);
          
          const isRecoveryError = errorFlowType === 'recovery';
          const isSignupError = errorFlowType === 'signup';
          let errorMsg;

          if (isRecoveryError) {
            errorMsg = 'Invalid or expired reset link.';
          } else if (isSignupError) {
            errorMsg = 'Invalid or expired signup link.';
          } else {
            errorMsg = 'Invalid or expired invitation link.';
          }

          if (finalErrorCode === 'otp_expired') {
            errorMsg = isRecoveryError
              ? 'This reset link has expired. Please request a new one from the team.'
              : isSignupError
                ? 'This signup link has expired. Please request a new magic link from the login page.'
                : 'This invitation link has expired. Please request a new invitation from your administrator.';
          } else if (finalErrorCode === 'access_denied') {
            errorMsg = isRecoveryError
              ? 'Access denied. This reset link is invalid or has already been used.'
              : isSignupError
                ? 'Access denied. This signup link is invalid or has already been used.'
                : 'Access denied. This invitation link is invalid or has already been used.';
          }
          
          setMsg(errorMsg, 'error');
          
          // Hide password form and show error message
          const form = document.getElementById('set-password-form');
          if (form) {
            form.style.display = 'none';
          }
          
          // Add helpful message
          const msgEl = document.getElementById('msg');
          if (msgEl) {
            msgEl.style.marginTop = '20px';
            msgEl.style.textAlign = 'center';
            msgEl.innerHTML = `
              <div style="padding: 20px; background-color: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #991b1b;">
                <strong>‚ö†Ô∏è ${errorMsg}</strong>
                <p style="margin: 12px 0 0; font-size: 14px; color: #7f1d1d;">
                  If you need a new invitation or reset link, please contact your administrator or 
                  <a href="mailto:info@onehopechurch.com" style="color: #00A0DF; text-decoration: underline;">contact us</a>.
                </p>
              </div>
            `;
          }
          
          // Clean up URL
          window.history.replaceState({}, '', window.location.pathname);
          return;
        }
        
        // Check URL hash for Supabase tokens (#access_token=...)
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');
        const type = hashParams.get('type');

        // Check URL params for tokens as fallback
        const paramAccessToken = urlParams.get('access_token');
        const paramRefreshToken = urlParams.get('refresh_token');
        const paramType = urlParams.get('type');

        // Use hash params if available, otherwise use URL params
        const token = accessToken || paramAccessToken;
        const refresh = refreshToken || paramRefreshToken;
        const tokenType = type || paramType;

        if (token && (tokenType === 'invite' || tokenType === 'recovery' || tokenType === 'signup')) {
          currentAuthFlow = tokenType;
          console.log('‚úÖ Found auth token in URL for flow:', tokenType);
          
          // Set the session using the tokens
          const { data: sessionData, error: sessionError } = await sb.auth.setSession({
            access_token: token,
            refresh_token: refresh
          });

          if (sessionError) {
            console.error('‚ùå Session error:', sessionError);
            const errorMsg = tokenType === 'recovery'
              ? 'Invalid or expired reset link. Please request a new one.'
              : tokenType === 'signup'
                ? 'Invalid or expired signup link. Please request a new magic link from the login page.'
                : 'Invalid or expired invitation link. Please request a new invitation.';
            setMsg(errorMsg, 'error');
            return;
          }

          if (sessionData?.session) {
            try {
              localStorage.setItem('sb_access_token', sessionData.session.access_token);
              localStorage.setItem('sb_refresh_token', sessionData.session.refresh_token);
            } catch (storageError) {
              console.warn('‚ö†Ô∏è Unable to persist Supabase session tokens:', storageError);
            }
          }

          if (sessionData?.user) {
            supabaseUser = sessionData.user;
            console.log('‚úÖ User session established:', supabaseUser.email);
            
            // Clean up URL
            const cleanPath = window.location.pathname;
            const returnUrl = getReturnUrl();
            if (returnUrl && returnUrl !== '/') {
              window.history.replaceState({}, '', cleanPath + '?return=' + encodeURIComponent(returnUrl));
            } else {
              window.history.replaceState({}, '', cleanPath);
            }
          }
        } else {
          // Check if user is already authenticated
          const { data: { user }, error: userError } = await sb.auth.getUser();
          if (user && !userError) {
            supabaseUser = user;
            console.log('‚úÖ User already authenticated:', user.email);
          } else {
            console.error('‚ùå No valid auth token found');
            setMsg('Invalid or expired link. Please check your email for a valid invitation or reset email.', 'error');
          }
        }
      } catch (error) {
        console.error('‚ùå Auth redirect error:', error);
        setMsg('Failed to process the link. Please try again.', 'error');
      }
    }

    // Set password
    async function setPassword() {
      if (!sb || !supabaseUser) {
        setMsg('Please wait while we verify your invitation...', 'info');
        return;
      }

      const password = document.getElementById('password').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();
      const btn = document.getElementById('btn-set-password');

      // Validation
      if (!password) {
        setMsg('Please enter a password', 'error');
        return;
      }

      if (password.length < 8) {
        setMsg('Password must be at least 8 characters', 'error');
        return;
      }

      if (password !== confirmPassword) {
        setMsg('Passwords do not match', 'error');
        return;
      }

      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Setting Password...';
        setMsg('Setting your password...', 'info');

        // Update user password
        const { data, error } = await sb.auth.updateUser({
          password: password
        });

        if (error) {
          console.error('‚ùå Password update error:', error);
          throw error;
        }

        if (data?.user) {
          console.log('‚úÖ Password set successfully');
          const successMessage = currentAuthFlow === 'recovery'
            ? 'Password reset successfully! Redirecting...'
            : currentAuthFlow === 'signup'
              ? 'Account verified! Password set successfully. Redirecting...'
              : 'Password set successfully! Redirecting...';
          setMsg(successMessage, 'success');

          // Initialize profile if needed
          try {
            await profileInit(data.user.id, data.user.email);
          } catch (profileError) {
            console.warn('‚ö†Ô∏è Profile init warning:', profileError);
            // Continue even if profile init fails
          }

          // Set app auth token
          await setAppAuthToken({
            name: data.user.email,
            email: data.user.email,
            planning_center_id: null,
            avatar_url: null
          }, data.user);

          // Redirect to app
          setTimeout(() => {
            const returnUrl = getReturnUrl();
            const redirectUrl = buildRedirectUrl(returnUrl);
            console.log('üîÑ Redirecting to:', redirectUrl);
            window.location.href = redirectUrl;
          }, 1500);
        } else {
          throw new Error('Failed to set password');
        }
      } catch (error) {
        console.error('‚ùå Set password error:', error);
        setMsg(error.message || 'Failed to set password. Please try again.', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-key"></i> Set Password';
      }
    }

    // Build redirect URL with auth token
    function buildRedirectUrl(returnUrl) {
      const token = localStorage.getItem('onehope_token');
      const user = localStorage.getItem('onehope_user');
      const sbAccessToken = localStorage.getItem('sb_access_token');
      const sbRefreshToken = localStorage.getItem('sb_refresh_token');
      const rememberPreference = getRememberPreference();
      
      let url;
      try {
        url = new URL(returnUrl, window.location.origin);
      } catch (e) {
        url = new URL('/', window.location.origin);
      }

      const isSameOrigin = url.origin === window.location.origin;
      
      if (token && !isSameOrigin) {
        url.searchParams.set('auth_token', token);
        if (user) {
          url.searchParams.set('auth_user', user);
        }
        if (sbAccessToken) {
          url.searchParams.set('sb_access_token', sbAccessToken);
        }
        if (sbRefreshToken) {
          url.searchParams.set('sb_refresh_token', sbRefreshToken);
        }
        url.searchParams.set('remember', rememberPreference ? 'true' : 'false');
      }
      
      return url.toString();
    }

    function togglePw(fieldId) {
      const i = document.getElementById(fieldId);
      const btn = event.currentTarget;
      const icon = btn.querySelector('i');
      const isPw = i.type === 'password';
      i.type = isPw ? 'text' : 'password';
      icon.classList.toggle('fa-eye');
      icon.classList.toggle('fa-eye-slash');
    }

    function setMsg(m, v = 'info') {
      try {
        const el = document.getElementById('msg');
        if (el) {
          el.textContent = m || '';
          el.className = `helper-text ${v}`;
        }
      } catch (error) {
        console.error('‚ùå setMsg error:', error);
      }
    }

    async function profileInit(userId, email) {
      try {
        const response = await fetch('/api/auth/profile/init', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ supabase_user_id: userId, email })
        });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Failed to initialize profile' }));
          console.error('‚ùå Profile init failed:', errorData);
          throw new Error(errorData.message || errorData.error || 'Failed to initialize profile');
        }
        return await response.json();
      } catch (error) {
        console.error('‚ùå Profile init error:', error);
        throw error;
      }
    }

    async function setAppAuthToken(profile, supabaseUser) {
      try {
        const rememberPreference = getRememberPreference();
        const payload = {
          supabase_id: supabaseUser.id,
          planning_center_id: profile.planning_center_id,
          name: profile.name || supabaseUser.email,
          email: profile.email || supabaseUser.email,
          avatar_url: profile.avatar_url || null,
          timestamp: Date.now(),
          remember_me: rememberPreference
        };
        localStorage.setItem('onehope_token', btoa(JSON.stringify(payload)));
        localStorage.setItem('onehope_user', JSON.stringify({
          id: supabaseUser.id,
          name: payload.name,
          email: payload.email,
          avatar_url: payload.avatar_url
        }));
        persistRememberPreference(rememberPreference);

        // Also store Supabase tokens from current session
        if (sb) {
          try {
            const { data: session } = await sb.auth.getSession();
            if (session?.session) {
              localStorage.setItem('sb_access_token', session.session.access_token);
              localStorage.setItem('sb_refresh_token', session.session.refresh_token);
            }
          } catch (e) {
            console.warn('‚ö†Ô∏è Could not store Supabase tokens:', e);
          }
        }
      } catch (error) {
        console.error('‚ùå setAppAuthToken error:', error);
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      init();
      
      const btn = document.getElementById('btn-set-password');
      if (btn) {
        btn.addEventListener('click', setPassword);
      }

      const form = document.getElementById('set-password-form');
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          setPassword();
        });
      }
    });
  </script>
</body>
</html>
